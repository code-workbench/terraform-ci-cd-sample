# Terraform Environment Management Guide

This project uses separate state files for different environments with Azure AD authentication to prevent conflicts and ensure isolation.

## Environment Setup

### Prerequisites
1. Azure CLI configured and logged in (`az login`)
2. Terraform installed
3. Appropriate Azure permissions (Contributor role recommended)

### Backend Configuration Files
- `backend-local.tfbackend` - Local development state
- `backend-dev.tfbackend` - Development environment state  
- `backend-prod.tfbackend` - Production environment state

All backend configurations use Azure AD authentication (`use_azuread_auth = true`)

## Initial Setup

### 1. Create Azure Storage Account
Run the setup script to create the storage account and assign permissions:
```bash
chmod +x ./scripts/setup-azure-backend.sh
./scripts/setup-azure-backend.sh
```

This script will:
- Create a resource group for Terraform state
- Create a storage account with a unique name
- Create the blob container
- Assign Storage Blob Data Contributor role to your user

### 2. Update Backend Configuration Files
After running the setup script, update the backend configuration files with the actual storage account name generated by the script.

## Authentication Requirements

### Local Development
Ensure you're logged in to Azure CLI:
```bash
az login
az account show  # Verify correct subscription
```

### CI/CD Pipeline
For service principal authentication, set these environment variables:
```
ARM_CLIENT_ID=<service-principal-id>
ARM_CLIENT_SECRET=<service-principal-secret>
ARM_SUBSCRIPTION_ID=<subscription-id>
ARM_TENANT_ID=<tenant-id>
```

The service principal needs the "Storage Blob Data Contributor" role on the storage account.

## Usage

### Local Development
```bash
# Initialize with local backend
terraform init -backend-config=backend-local.tfbackend

# Create workspace for your feature/development
terraform workspace new feature-xyz
# or select existing workspace
terraform workspace select feature-xyz

# Plan and apply
terraform plan -var-file=terraform-local.tfvars
terraform apply -var-file=terraform-local.tfvars
```

### Development Environment
```bash
# Initialize with dev backend
terraform init -backend-config=backend-dev.tfbackend

# Use default workspace or create dev workspace
terraform workspace select default
# or
terraform workspace new dev

# Plan and apply
terraform plan -var-file=terraform-dev.tfvars
terraform apply -var-file=terraform-dev.tfvars
```

### Production Environment
```bash
# Initialize with prod backend
terraform init -backend-config=backend-prod.tfbackend

# Use default workspace or create prod workspace
terraform workspace select default
# or
terraform workspace new prod

# Plan and apply
terraform plan -var-file=terraform-prod.tfvars
terraform apply -var-file=terraform-prod.tfvars
```

## CI/CD Pipeline Integration

### Environment Variables for Service Principal
Set these in your pipeline:
```
ARM_CLIENT_ID=<service-principal-id>
ARM_CLIENT_SECRET=<service-principal-secret>
ARM_SUBSCRIPTION_ID=<subscription-id>
ARM_TENANT_ID=<tenant-id>
```

**Note:** No `ARM_ACCESS_KEY` needed when using Azure AD authentication

### Pipeline Commands
```bash
# For dev environment
terraform init -backend-config=backend-dev.tfbackend
terraform plan -var-file=terraform-dev.tfvars

# For prod environment  
terraform init -backend-config=backend-prod.tfbackend
terraform plan -var-file=terraform-prod.tfvars
```

### Service Principal Permissions
Your CI/CD service principal needs these roles:
1. **Storage Blob Data Contributor** - On the storage account (for state file access)
2. **Contributor** - On the subscription or resource group (for resource management)

## Best Practices

1. **Never mix environments**: Always use the correct backend config file
2. **Use workspaces**: Create feature-specific workspaces for local development
3. **Variable files**: Use environment-specific .tfvars files
4. **State isolation**: Each environment has its own state file path
5. **Access control**: Use different Azure permissions per environment

## Troubleshooting

### Switching Between Environments
If you need to switch between environments:
```bash
# Clean up current backend
rm -rf .terraform/

# Initialize with new environment
terraform init -backend-config=backend-<environment>.tfbackend
```

### Workspace Management
```bash
# List workspaces
terraform workspace list

# Create new workspace
terraform workspace new <name>

# Switch workspace
terraform workspace select <name>

# Delete workspace (be careful!)
terraform workspace delete <name>
```